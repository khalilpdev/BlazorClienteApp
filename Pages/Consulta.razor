@page "/consulta"
@using BlazorClienteApp.Models
@inject ClienteService ClienteService
@inject NavigationManager Navigation

<PageTitle>Consulta de Clientes</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Clientes Cadastrados</h3>
        <button class="btn btn-success" @onclick="NovoCliente">
            <i class="bi bi-plus-lg"></i> Novo Cliente
        </button>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Filtros</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" @bind="filtroNome" @bind:event="oninput" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Telefone</label>
                    <input type="text" class="form-control" @bind="filtroTelefone" @bind:event="oninput" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">CPF/CNPJ</label>
                    <input type="text" class="form-control" @bind="filtroCpfCnpj" @bind:event="oninput" />
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" @onclick="AplicarFiltros">Filtrar</button>
                <button class="btn btn-outline-secondary ms-2" @onclick="LimparFiltros">Limpar</button>
            </div>
        </div>
    </div>

    <!-- Tabela de Clientes -->
    @if (clientesFiltrados == null || !clientesFiltrados.Any())
    {
        <div class="alert alert-info">Nenhum cliente encontrado.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th>CPF/CNPJ</th>
                        <th>Data do Cadastro</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cliente in clientesFiltrados)
                    {
                        <tr>
                            <td>@cliente.Nome</td>
                            <td>@cliente.Telefone</td>
                            <td>@cliente.CpfCnpj</td>
                            <td>@cliente.DataDoCadastro.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" @onclick="() => EditarCliente(cliente.Id)">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => RemoverCliente(cliente.Id)">
                                    <i class="bi bi-trash"></i> Excluir
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Cliente> clientesFiltrados = new();
    private string filtroNome = string.Empty;
    private string filtroTelefone = string.Empty;
    private string filtroCpfCnpj = string.Empty;

    protected override void OnInitialized()
    {
        CarregarClientes();
    }

    private void CarregarClientes()
    {
        clientesFiltrados = ClienteService.ObterTodos();
    }

    private void AplicarFiltros()
    {
        clientesFiltrados = ClienteService.Filtrar(
            string.IsNullOrWhiteSpace(filtroNome) ? null : filtroNome,
            string.IsNullOrWhiteSpace(filtroTelefone) ? null : filtroTelefone,
            string.IsNullOrWhiteSpace(filtroCpfCnpj) ? null : filtroCpfCnpj
        );
    }

    private void LimparFiltros()
    {
        filtroNome = string.Empty;
        filtroTelefone = string.Empty;
        filtroCpfCnpj = string.Empty;
        CarregarClientes();
    }

    private void NovoCliente()
    {
        Navigation.NavigateTo("/cadastro");
    }

    private void EditarCliente(Guid id)
    {
        Navigation.NavigateTo($"/cadastro/{id}");
    }

    private void RemoverCliente(Guid id)
    {
        if (confirm("Deseja realmente excluir este cliente?"))
        {
            ClienteService.Remover(id);
            CarregarClientes();
        }
    }

    private bool confirm(string message)
    {
        // Em produção, usar JSInterop para window.confirm
        return true;
    }
}